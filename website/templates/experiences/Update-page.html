{% extends "base.html" %}

{% block content %}

{% from 'bootstrap5/form.html' import render_form %}


<main>
    <!-- Create an experience -->
    <div class="major-container" id="create-experience-section">
        <div class="container wrapper">
            <div class="row">
                <div class="event-header">
                    <div class="event-page-header">
                        <h3 class="event-page-header-small">Update your experience<br></h3>
                    </div>
                </div>
                <div class="col-md-12">
                    <p class="paragraph-spacing">This is where your vision gets a fresh coat of inspiration, allowing you to fine-tune every aspect of your unique experience.
                        Let's work together to bring new life to your event and make it even more extraordinary!</p>

                        <!-- Add this to display flashed messages -->
                        <div class="col-md-6">
                            {% with messages = get_flashed_messages() %}
                            {% if messages %}
                            <div class="alert alert-success">
                                <ul>
                                    {% for message in messages %}
                                    <li>{{ message }}</li>
                                    {% endfor %}
                                </ul>
                            </div>
                            {% endif %}
                            {% endwith %}
                        </div>  
                </div>
                <hr class="comment-spacer">
            </div>
        </div>

        <!--- Dynamic question container -->
        <div class="container wrapper">
            <div class="row">
                <div class="container col-md-6">

                    <!-- Experience Name & Type-->
                    {{ render_form(form) }}
                </div>

                <div class="col-md-2"></div>

                <!--- Top tips -->
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-body text-center">
                            <h6 class="card-title"><i class="bi bi-lightbulb-fill text-warning"></i><b> Top tip</b></h6>
                            <p class="card-text" id="tip-content">Capture attention with a distinctive name! Include
                                your destination's charm, your experience's essence, or a hint of
                                adventure. A unique name not only piques curiosity but also sets the stage for an
                                unforgettable experience.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Event Created Modal -->
    <div class="modal" tabindex="-1" role="dialog" id="confirmation-modal">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Event Created</h5>
                </div>
                <div class="modal-body">
                    <p>Your event has been created with the following details:</p>
                    <ul>
                        <li><strong>Event ID:</strong> <span id="event-id-modal"></span></li>
                        <li><strong>Status:</strong> Open</li>
                    </ul>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
            </div>
        </div>
    </div>

    <!-- JS scripting import -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-HwwvtgBNo3bZJJLYd8oVXjrBZt8cqVSpeBNS5n7C8IVInixGAoxmnlMuBnhbgrkm"
        crossorigin="anonymous"></script>

    <!-- JS to handle the dynamic form -->
    <script>
        const questions = document.querySelectorAll(".question");
        let currentQuestionIndex = 0;

        // Define an array of top tip texts
        const topTips = [
            "Capture attention with a distinctive name! Include your destination's charm, your experience's essence, or a hint of adventure.A unique name not only piques curiosity but also sets the stage for an unforgettable experience.",
            "Balancing time and theme is key. Carefully choose your experience's duration and type to cater to your audience. Short and sweet or a deep dive into culture? The choice is yours, but it sets the stage for the adventure ahead.",
            "We find the optimal group size is between 6 - 12 users for the most engaging experience. The bigger the group, the less people are willing to pay.",
            "Give your audience a view into what your experience is about with up to 3 photos. Make sure they are in high resolution to draw people in and sell your experience!"
        ];

        // Function to update the top tip text based on the current index
        function updateTopTip() {
            const tipContent = document.getElementById("tip-content");
            tipContent.textContent = topTips[currentQuestionIndex];
        }

        function showNextQuestion() {
            if (currentQuestionIndex < questions.length - 1) {
                questions[currentQuestionIndex].style.display = "none";
                currentQuestionIndex++;
                questions[currentQuestionIndex].style.display = "block";
                updateButtonStatus();
                updateTopTip(); // Update the top tip text
            }
        }

        function showPreviousQuestion() {
            if (currentQuestionIndex > 0) {
                questions[currentQuestionIndex].style.display = "none";
                currentQuestionIndex--;
                questions[currentQuestionIndex].style.display = "block";
                updateButtonStatus();
                updateTopTip(); // Update the top tip text
            }
        }

        const nextButton = document.getElementById("next-button");
        const confirmButton = document.getElementById("confirm-button");
        const photoInput = document.getElementById("formFileMultiple");
        nextButton.addEventListener("click", showNextQuestion);

        const backButton = document.getElementById("back-button");
        backButton.addEventListener("click", showPreviousQuestion);

        // Function to update the button status based on required fields
        function updateButtonStatus() {
            const currentQuestion = questions[currentQuestionIndex];
            const requiredFields = currentQuestion.querySelectorAll('[required]');
            const isEmpty = Array.from(requiredFields).some(field => !field.value.trim());

            backButton.style.display = currentQuestionIndex === 0 ? "none" : "inline-block";

            if (currentQuestionIndex === questions.length - 1) {

                // If on the last question, hide "Next" button and show "Confirm" button
                nextButton.style.display = "none";
                confirmButton.style.display = "inline-block";

                // Enable "Confirm" button if the final photo field has a photo
                confirmButton.disabled = !photoInput.files || photoInput.files.length === 0;
            } else {
                nextButton.style.display = "inline-block";
                confirmButton.style.display = "none";
                confirmButton.disabled = true; // Disable "Confirm" button on other questions
            }

            nextButton.disabled = isEmpty;
        }

        // Initialise the button status
        updateButtonStatus();

        // Add event listeners to input fields within questions
        const inputFields = document.querySelectorAll(".question input, .question select, .question textarea");
        inputFields.forEach(field => {
            field.addEventListener("input", updateButtonStatus);
        });

        // Add an event listener to the photo input to check for changes
        photoInput.addEventListener("change", updateButtonStatus);

        // Generate a random event ID
        function generateRandomEventId() {
            return Math.floor(Math.random() * 1000000);
        }

        // Function to handle event confirmation and display confirmation message
        function confirmEvent() {

            // Generate a random event ID (you can use your method here)
            const randomEventId = generateRandomEventId();

            // Replace the content in the "Create an Experience" section
            const createExperienceSection = document.getElementById("create-experience-section");
            createExperienceSection.innerHTML = `
                <div class="container wrapper" id="experience-created-section">
                    <div class="row">
                        <div class="event-header">
                            <div class="event-page-left-header">
                                <h3 class="event-page-header-small">Event Created<br></h3>
                            </div>
                            <br><br>
                        </div>
                        <div class="col-md-12">
                            Your event has been created with the following details:
                        </div>
                    </div>
                    <hr>

                    <div class="row">
                        <div>
                            <ul>
                                <li><strong>Event ID:</strong> <span id="event-id">${randomEventId}</span></li>
                                <li><strong>Status:</strong> Open</li>
                            </ul>
                            <button id="createAnotherExperienceButton" class="btn btn-primary btn-md custom-btn">
                                Create another experience
                            </button>

                        </div>
                    </div>
                </div>`;

            // Show the confirmation modal
            const confirmationModal = new bootstrap.Modal(document.getElementById("confirmation-modal"));
            confirmationModal.show();
        }

        // Handle "Confirm" button click
        confirmButton.addEventListener("click", confirmEvent);

    </script>

</main>

{% endblock %}